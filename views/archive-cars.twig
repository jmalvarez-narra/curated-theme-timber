{% extends "base.twig" %}

{% block content %}
	<div class="content-wrapper">
		<div class="featured-container">

		<div class="overlay dark-overlay"></div>
		{% if post.thumbnail.src %}
			{# <div class="measure"></div> #}

			<div class="featured" style="--bg-image: url({{ post.thumbnail.src }});"></div>
		{% else %}
			<div class="featured" style="--bg-image: url({{ site.theme.link }}/dist/assets/img/default.png);"></div>
		{% endif %}
		</div>

		<article class="post-type-{{post.post_type}}" id="post-{{post.ID}}">
			<section class="article-content">
				<div class="section-heading">
					<h3 class="title">{{ title }}</h3>

					<h5 class="subtitle mb-0">INVENTORY</h5>
				</div>

        <div class="article-body">
					{{post.content}}
				</div>

        <div class="container-fluid mb-5">
          <div class="row">
            <div class="col-12 col-md-6 filter-container"></div>

            <div class="col-12 col-md-6 filter-container">
              <div class="float-end">
                <label class="sort-by">SORT BY:</label>

                <select id="filter-car" class="filter-container">
                  <option value="Inventory" selected>VIEW ALL</option>
                  <option value="Latest">LATEST ARRIVALS</option>
                  <option value="Available">CURRENT INVENTORY</option>
                  <option value="Sold">PREVIOUSLY SOLD</option>

                  {% for category in categories %}
                    <option value="{{ category.name }}">{{ category.name }}</option>
                  {% endfor %}
                </select>

                <select id="width_tmp_select">
                  <option id="width_tmp_option"></option>
                </select>
              </div>
            </div>
          </div>

          <div id="car__list" class="row car-list"></div>

          {% include 'partial/list-loader.twig' %}

          <div class="justify-content-end mb-4" style="display: none;">
            <button id="load-more-car-btn" class="btn btn-primary load-more-btn">More</button>
          </div>
        </div>
			</section>
		</article>
	</div><!-- /content-wrapper -->

  <script>
    $(document).ready(function() {
      let page = 0;
      let page_limit = window.innerWidth <= 992 ? 8 : 9;

      const getCars = () => {
        page++;

        $("#load-more-car-btn").attr('disabled', true);
        $(".list-loader").removeClass("d-none");

        $.ajax({
          type: 'POST',
          url: '/wp-admin/admin-ajax.php',
          dataType: 'html',
          data: {
            action: 'get_cars',
            limit: page_limit,
            page: page,
            sort: $("#sort-car").val(),
            'filter-category': $("#filter-car").val()
          },
          success: function(data) {
            const carsCount = $('<div></div>').html(data).find('.car-item').size();

            if (carsCount < page_limit) {
              $("#load-more-car-btn").parent().hide();
            } else {
              $("#load-more-car-btn").parent().show();
            }

            if (carsCount) $('#car__list').append(data);

            $("#load-more-car-btn").attr('disabled', false);
            $(".list-loader").addClass("d-none");
          },
          error: function(data) {
            $("#load-more-car-btn").attr('disabled', false);
            $(".list-loader").addClass("d-none");
          }
        });
      };

      $("#load-more-car-btn").click((e) => {
        e.preventDefault();

        getCars();
      });

      $("#sort-car").change((e) => {
        e.preventDefault();

        page = 1;

        $('#car__list').html('');
        $("#load-more-car-btn").parent().hide();
        $(".list-loader").removeClass("d-none");

        $.ajax({
          type: 'POST',
          url: '/wp-admin/admin-ajax.php',
          dataType: 'html',
          data: {
            action: 'get_cars',
            limit: page_limit,
            page: page,
            sort: e.target.value,
            'filter-category': $("#filter-car").val()
          },
          success: function(data) {
            const carsCount = $('<div></div>').html(data).find('.car-item').size();

            if (carsCount < page_limit) {
              $("#load-more-car-btn").parent().hide();
            } else {
              $("#load-more-car-btn").parent().show();
            }

            if (carsCount) {
              $('#car__list').html(data);
            }

            $(".list-loader").addClass("d-none");
          },
          error: function(data) {
            $("#load-more-car-btn").parent().show();
            $(".list-loader").addClass("d-none");
          }
        });
      });

      $("#filter-car").change(function (e) {
        e.preventDefault();

        $("#width_tmp_option").html($('#filter-car option:selected').text());
        $(this).css("width", `calc(5rem + ${$("#width_tmp_select").width()}px)`);

        page = 1;

        $('#car__list').html('');
        $("#load-more-car-btn").parent().hide();
        $(".list-loader").removeClass("d-none");

        $.ajax({
          type: 'POST',
          url: '/wp-admin/admin-ajax.php',
          dataType: 'html',
          data: {
            action: 'get_cars',
            limit: page_limit,
            page: page,
            sort: $("#sort-car").val(),
            'filter-category': e.target.value
          },
          success: function(data) {
            const carsCount = $('<div></div>').html(data).find('.car-item').size();

            if (carsCount < page_limit) {
              $("#load-more-car-btn").parent().hide();
            } else {
              $("#load-more-car-btn").parent().show();
            }

            if (carsCount) {
              $('#car__list').html(data);
            }

            $(".list-loader").addClass("d-none");
          },
          error: function(data) {
            $("#load-more-car-btn").parent().show();
            $(".list-loader").addClass("d-none");
          }
        });
      });

      getCars();
    });
  </script>
{% endblock %}
